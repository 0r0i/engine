---
본 문서는 peer 개발 시 소통을 위해 임의로 작성되었으며
전체 개발의 진행방향과 무관하게 소통을 위한 문서이기에 혼동이 없으셨으면 합니다.
-frontalnh(namhoon)
---

# 최초 노드 boot 시의 시나리오
최초의 노드를 bootnode로 하는 최초의 p2p 네트워크를 형성하는 시나리오이다.
이 경우 it-chain의 bootnode가 반드시 해당 pc 의 ip로 설정되어 있어야 한다.

**현재 boot-node를 사용하지 않는다는 결론을 내렸는데, 그럼 어떤 방식으로 dial 할지를 정해야 한다.**

개략적인 프로세스는 다음과 같다.

1. 추가될 노드와의 통신을 위한 준비
2. 노드 내 컴포넌트간 통신을 위한 AMQP 서버 구동
3. 피어등록
4. 리더 선정

## 추가될 노드와의 통신을 위한 준비
현재 boot 된 최초의 노드를 bootnode로 하여 최초의 p2p 네트워크를 형성하기 위해 다른 노드와 gRPC를 사용한 통신망을 구축하며, 실제적인 gateway 컴포넌트에서 이루어 진다. gateway 패키지의 `start()` 함수호출을 통해 gRPC interface를 구축한다.

이러한 함수호출을 통해 다음과 같은 작업들이 수행되게 된다.
1. gRPC interface 구축
2. amqp server 환경 세팅

이 과정에서 gRPC 인터페이스를 구축함에 있어 grpc lib을 사용하는 것이 일반적이지만, it-chain 에서는 이를 보다 쉽게 구현하기 위해 별도로 p2p 네트워크 라이브러리인 `bifrost` 라이브러리를 자체 제작하여 사용하고있다. `bifrost` 를 통해 gRPC 인터페이스를 보다 쉽게 구축 할 수 있을 뿐만 아니라 해당 p2p 네트워크의 전체 연결정보를 쉽게 관리하고 정보를 열람할 수 있다.

## 노드 내 컴포넌트간 통신을 위한 AMQP 서버 구동
노드 내의 각 컴포넌트들은 AMQP 를 사용하여 통신하며 rabbitmq 를 통해 구현되며, 이를 위해 amqp 서버를 구동이 필요하다.
amqp 서버 구동의 경우 앞의 gRPC 인터페이스를 구축함에 있어 gateway 패키지의 start() 함수를 호출하는 시점에서 amqp 서버의 구동까지 같이 수행하므로 별도로 다른 조작은 필요하지 않다.

**어느 단계에서 gateway.Start() 가 수행이 될지 정해지지 않았다.**

## 노드 등록
해당 노드 객체를 생성하여 노드 리스트에 등록시킨다.
이때 nodeId 가 어떤 방식으로 생성되는지에 대한 정리가 필요하다.

## 리더 선정
최초의 노드의 경우 아직 P2P 네트워크가 구성되지 않았으므로 **리더는 존재하지 않는다.**
다만 이후의 노드가 해당 노드에 dial을 거는 경우 아직 leader repo 에 leader가 없는 경우 dial을 받은 노드가 leader가 되어 repo에 저장되게 된다.



# 이후의 노드가 네트워크에 연결되는 시나리오

1. p2p 네트워크 접속
2. 피어 생성 및 저장
3. 리더 선정

## P2P 네트워크 접속
특정 ip로 dial 하여 P2P 네트워크에 접속하며 다음과 같은 과정을 거칩니다.

1. dial 을 통해 P2P 네트워크에 접속
cli 에서 특정 ip로 dial 하여 p2p 네트워크에 접속합니다.
2. 리더 노드 확인
dial 하는 시점에서 dial을 수신하는 노드는 leader node가 되고 이 내용은 leader repo에 저장됩니다.
3. 네트워크 내의 다른 peer 정보를 해당 노드의 클라이언트에 저장


## 피어 생성 및 저장
1. 내 ip를 기준으로 노드 정보 생성 및 저장
2. 생성한 노드 정보를 기존의 노드들에게 전달하고 전체 P2P 네트워크의 구성 노드정보에 추가된 노드를 추가

## 리더 선정
리더를 선출하고 리더가 누구인지에 대한 정보를 모든 노드들 사이에서 공유


---
아래 내용은 소통을 위해 생각의 흐름대로 임의로 작성하였으며
추후 개선될 예정입니다.
---


# 트랜잭션 발생 시나리오
1. 사용자가 tx 생성 요청
2. txpool 에 저장
3. txpool에서 consume
4. pool에 등록
5. api 호출
createtx
6. amqp 등록
7. create event 객체생성
8. pool에서 tx 생성
9. leveldb 저장


# 블록 생성
# 합의과정
# 블록 저장
# 블록 전파
